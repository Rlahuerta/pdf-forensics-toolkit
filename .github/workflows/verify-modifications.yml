name: Verify Modifications

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  verify:
    name: Verify Code Changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libmagic1 exiftool
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pymupdf>=1.26.0
        pip install pikepdf>=10.0.0
        pip install pdfplumber>=0.11.0
        pip install pypdf>=6.0.0
        pip install pypdf2>=3.0.0
        pip install python-magic>=0.4.27
        pip install pillow>=12.0.0
        pip install pyexiftool>=0.5.0
        pip install pdfid>=1.1.0
        pip install peepdf-3>=5.0.0
        pip install pyhanko>=0.32.0
        pip install cryptography>=46.0.0
        pip install endesive>=2.19.0
        pip install reportlab>=4.0.0
        pip install pytest>=8.0.0
        pip install pytest-cov>=5.0.0
        
    - name: Verify Python syntax
      run: |
        python -m py_compile pdf_source_identifier.py
        python -m py_compile verify_signature.py
        python -m py_compile compare_pdfs.py
        python -m py_compile pdf_forensics/*.py
        
    - name: Run test suite
      run: |
        python -m pytest tests/ -v --tb=short
        
    - name: Run tests with coverage
      run: |
        python -m pytest tests/ --cov=. --cov-report=term-missing --cov-report=xml
        
    - name: Display coverage summary
      if: always()
      run: |
        if [ -f coverage.xml ]; then
          echo "Coverage report generated successfully"
          python -m pytest tests/ --cov=. --cov-report=term
        fi
        
    - name: Check for critical files
      run: |
        test -f pdf_source_identifier.py || exit 1
        test -f verify_signature.py || exit 1
        test -f compare_pdfs.py || exit 1
        test -d pdf_forensics || exit 1
        test -d tests || exit 1
        echo "✓ All critical files present"
        
    - name: Validation summary
      if: success()
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "✅ All verification checks passed!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "✓ Python syntax validated"
        echo "✓ Test suite passed"
        echo "✓ Code coverage analyzed"
        echo "✓ Critical files verified"
        echo ""
        echo "This PR is ready for review."
