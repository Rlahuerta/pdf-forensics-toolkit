name: Verify Modifications

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  verify:
    name: Verify Code Changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Conda environment
      uses: conda-incubator/setup-miniconda@v3
      with:
        environment-file: environment.yml
        activate-environment: pdf-forensics-toolkit
        python-version: 3.11
        auto-activate-base: false
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libmagic1 exiftool
        
    - name: Verify Python syntax
      shell: bash -el {0}
      run: |
        python -m py_compile pdf_source_identifier.py
        python -m py_compile verify_signature.py
        python -m py_compile compare_pdfs.py
        python -m py_compile pdf_forensics/*.py
        
    - name: Run test suite
      shell: bash -el {0}
      run: |
        python -m pytest tests/ -v --tb=short
        
    - name: Run tests with coverage
      shell: bash -el {0}
      run: |
        python -m pytest tests/ --cov=. --cov-report=term-missing --cov-report=xml
        
    - name: Display coverage summary
      if: always()
      shell: bash -el {0}
      run: |
        if [ -f coverage.xml ]; then
          echo "Coverage report generated successfully"
          python -m pytest tests/ --cov=. --cov-report=term
        fi
        
    - name: Check for critical files
      run: |
        test -f pdf_source_identifier.py || exit 1
        test -f verify_signature.py || exit 1
        test -f compare_pdfs.py || exit 1
        test -d pdf_forensics || exit 1
        test -d tests || exit 1
        echo "✓ All critical files present"
        
    - name: Validation summary
      if: success()
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "✅ All verification checks passed!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "✓ Python syntax validated"
        echo "✓ Test suite passed"
        echo "✓ Code coverage analyzed"
        echo "✓ Critical files verified"
        echo ""
        echo "This PR is ready for review."
